<!--
 * @Descripttion: 完整柱状图
 * @Author: tom-z(spirit108@foxmail.com)
 * @Date: 2020-03-06 09:54:44
 * @LastEditors: tom-z(spirit108@foxmail.com)
 * @LastEditTime: 2020-03-06 17:34:37
 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://d3js.org/d3.v5.js"></script>
  <title>Document</title>
  <style>
    .svg-box {
      border: 1px solid #ccc;
      width: 500px;
      height: 400px;
    }
  </style>
</head>
<body>
  <div class="svg-box"></div>
  <script>
    let config = {
      warpW: 500,
      warpH: 400,
      warpBg: "#faf0b1",
      wrapPadding: 30,
      barW: 50,
      barPlace: 80
    };
    let data = [
      { name:"周一", value: 300, },
      { name:"周二", value: 100, },
      { name:"周三", value: 500, },
      { name:"周四", value: 200, },
      { name:"周五", value: 800, },
      { name:"周六", value: 400, },
      { name:"周日", value: 300, }
    ]
    console.log(d3);
    
    function initD3(ele) {
      let _svgEle = d3.select(ele).append("svg");
      _svgEle
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("style", `background: ${config.warpBg};`);
      return _svgEle;
    }
    let svgEle = initD3(".svg-box");
    // 
    function renderAxis(data, svgEle) {
      // 渲染x轴，离散型
      let nameArr = data.map(val => val.name);
      let valueArr = data.map(val => val.value);
      let xScale = d3.scaleBand()
        .domain(nameArr)
        .rangeRound([0, (config.warpW - config.wrapPadding * 2)]);
      let xAxis = d3.axisBottom()
        .scale(xScale);  
      svgEle.append("g")
        .attr(
          "transform",
          `translate(${config.wrapPadding}, ${config.warpH - config.wrapPadding})`
        )
        .call(xAxis);

      // 渲染y轴，线性
      let yScale = d3.scaleLinear()
        .domain([0, d3.max(valueArr)])
        .rangeRound([(config.warpH - config.wrapPadding * 2), 0]);

      let yAxis = d3.axisLeft()
        .scale(yScale);

      svgEle.append("g")
        .attr(
          "transform",
          `translate(${config.wrapPadding}, ${config.wrapPadding})`
        )
        .call(yAxis);
        return [
          xScale,
          yScale
        ];
    }
    let [xScale, yScale] = renderAxis(data, svgEle);

    // 渲染柱状图
    function renderBar(svgEle, data, xScale, yScale, option) {
      let type = "rect";
      let updateBar = svgEle.selectAll(type).data(data);
      updateBar.attr("width", option.barW).attr("height", val => {
          return yScale(800 - val.value);
        }).attr("fill", "red")
        .attr("x", (val, i) => {
          return xScale(val.name) + option.barW / 2;
        }).attr("y", val => {
          return option.warpH - yScale(800 - val.value) - option.wrapPadding;
        });
  
      // 数据大于元素节点,初次渲染
      let enterBar = updateBar.enter();
      // 处理数据大于元素时的情况
      enterBar.append(type)
        .attr("width", option.barW)
        .attr("height", val => {
          return yScale(800 - val.value);
        })
        .attr("fill", "red")
        .attr("x", (val, i) => {
          console.log();
          return xScale(val.name) + option.wrapPadding + (xScale.bandwidth() -  option.barW) / 2;
        }).attr("y", val => {
          return option.warpH - yScale(800 - val.value) - option.wrapPadding;
        });
      // 元素节点大于数据
      let exitBar = updateBar.exit();
      exitBar.remove();

      // // 渲染节点说明
      // let updateTxt = svgEle.selectAll("text").data(arr);
      // updateTxt.attr("x", (val, i) => {
      //     return 20 + i * option.barPlace + option.barW / 2;
      //   }).attr("y", val => {
      //     return 500 - val.value - 20;
      //   }).text(data => {
      //     return data.name;
      //   }).attr("text-anchor", "middle").attr("fill", "#080");
      // let enterTxt = updateTxt.enter();
      // enterTxt.append("text")
      //   .attr("x", (val, i) => {
      //     return 20 + i * option.barPlace + option.barW / 2;
      //   }).attr("y", val => {
      //     return 500 - val.value - 20;
      //   }).text(data => {
      //     return data.name;
      //   }).attr("text-anchor", "middle").attr("fill", "#080");
      //   let exitTxt = updateTxt.exit();
      //   exitTxt.remove();
    }
    
    renderBar(svgEle, data, xScale, yScale, config);
    console.log(xScale("周二"));
    console.log(yScale);
  </script>
</body>
</html>